<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kubernetes HPA 浅入深出 - guoweikuang 技术博客</title><meta name="Description" content=""><meta property="og:url" content="https://guoweikuang.github.io/posts/2024-05-09/">
  <meta property="og:site_name" content="guoweikuang 技术博客">
  <meta property="og:title" content="Kubernetes HPA 浅入深出">
  <meta property="og:description" content="HPA 是 Kubernetes 提供了一个弹性伸缩的重要功能，简单来说就是支持在应用资源消耗量很大的情况下，根据用户配置的阈值来自动进行扩容，减少人工的介入；在应用资">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-08T12:03:30+08:00">
    <meta property="article:modified_time" content="2024-05-08T12:03:30+08:00">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kubernetes HPA 浅入深出">
<meta name="twitter:description" content="HPA 是 Kubernetes 提供了一个弹性伸缩的重要功能，简单来说就是支持在应用资源消耗量很大的情况下，根据用户配置的阈值来自动进行扩容，减少人工的介入；在应用资">
<meta name="application-name" content="guoweikuang 技术博客">
<meta name="apple-mobile-web-app-title" content="guoweikuang 技术博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://guoweikuang.github.io/posts/2024-05-09/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubernetes HPA 浅入深出",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/guoweikuang.github.io\/posts\/2024-05-09\/"
        },"genre": "posts","wordcount":  6509 ,
        "url": "https:\/\/guoweikuang.github.io\/posts\/2024-05-09\/","datePublished": "2024-05-08T12:03:30+08:00","dateModified": "2024-05-08T12:03:30+08:00","publisher": {
            "@type": "Organization",
            "name": "guoweikuang"},"author": {
                "@type": "Person",
                "name": "guoweikuang"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="" data-header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="guoweikuang 技术博客">guoweikuang 技术博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="guoweikuang 技术博客">guoweikuang 技术博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubernetes HPA 浅入深出</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/guoweikuang" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>guoweikuang</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-05-08">2024-05-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6509 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;13 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一hpa-背景">一、HPA 背景</a></li>
    <li><a href="#二hpa-原理">二、HPA 原理</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#三hpa组件">三、HPA组件</a>
      <ul>
        <li><a href="#metrics-server-的安装">metrics-server 的安装</a></li>
      </ul>
    </li>
    <li><a href="#四hpa功能及算法细节">四、HPA功能及算法细节</a>
      <ul>
        <li><a href="#hpa-演进历程">HPA 演进历程</a></li>
        <li><a href="#hpa-算法细节">HPA 算法细节</a></li>
      </ul>
    </li>
    <li><a href="#五demo示例">五、Demo示例</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>HPA 是 Kubernetes 提供了一个弹性伸缩的重要功能，简单来说就是支持在应用资源消耗量很大的情况下，根据用户配置的阈值来自动进行扩容，减少人工的介入；在应用资源消耗量很小的情况下，进行缩容，进而减少资源的消耗量，达到节约成本的目的。本文会先从几个方面来讲解 HPA 的功能、使用、扩展及使用，分别为 <strong>HPA背景、HPA原理、HPA组件、HPA功能及算法细节、Demo示例、HPA 高级使用、自定义指标、定时扩容、HPA相关项目、HPA源码分析</strong>。由于一篇文章写完以上所有章节，会比较多内容，因此这里会分章节说明</p>
<h2 id="一hpa-背景">一、HPA 背景</h2>
<p>HPA 全称是 Horizontal Pod Autoscaler（水平扩缩），是通过 kubernetes HPA Controller(控制器）来实现对 workload(可理解为业务应用）进行自动的扩容和缩容。下面从两个方面来分析一下背景</p>
<ul>
<li>业务并不是全天候都是高负载情况，但同时为了应对每日或者活动期间的随机高峰流量，业务经常会将应用部署很多副本，很多时候都是负载很低，进而导致资源利用率很低</li>
<li>业务并不能准确评估服务所需的 CPU、内存等资源，一般都设置比较大，进而导致资源利用率低</li>
</ul>
<p>因此，为了解决业务资源利用率低、评估不准确等问题，需要通过动态调整方式来提高资源的利用率
目前 kubernetes 提供了三种维度的<a href="https://github.com/kubernetes/autoscaler" target="_blank" rel="noopener noreffer ">弹性扩缩方案</a>：</p>
<ul>
<li><strong>Cluster Autoscaler</strong>: 自动扩展和收缩 Kubernetes 集群 Node 的扩展，当集群容量不足时，它会自动去 Cloud Provider （支持 GCE、GKE 和 AWS）创建新的 Node，而在 Node 长时间资源利用率很低时自动将其删除以节省开支</li>
<li><strong>Vertical Pod Autoscaler</strong>: 用户无需为其pods中的容器设置最新的资源request。配置后，它将根据使用情况自动设置request，从而允许在节点上进行适当的调度，以便为每个pod提供适当的资源量，目前是 beta 状态</li>
<li><strong>Horizontal Pod Autoscaler</strong>: 基于 CPU 利用率自动扩缩 ReplicationController、Deployment、ReplicaSet 和 StatefulSet 中的 Pod 数量。除了 CPU 利用率，也可以基于其他应程序提供的 自定义度量指标 来执行自动扩缩</li>
</ul>
<p>这里我们只针对于 HPA 进行讲解，另外两种组件不展开</p>
<h2 id="二hpa-原理">二、HPA 原理</h2>
<h4 id="hpa-是如何工作的">HPA 是如何工作的</h4>
<p>下面图片描述了HPA的工作流程，HPA 是通过一个控制循环（HPA Controller)来定时对应用进行动态扩缩容的，通过启动k8s时配置 &ndash;horizontal-pod-autoscaler-sync-period 参数指定周期（默认值为 15 秒）。
<a href="https://imgse.com/i/pkVXNf1" target="_blank" rel="noopener noreffer "><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s21.ax1x.com/2024/05/09/pkVXNf1.webp"
        data-srcset="https://s21.ax1x.com/2024/05/09/pkVXNf1.webp, https://s21.ax1x.com/2024/05/09/pkVXNf1.webp 1.5x, https://s21.ax1x.com/2024/05/09/pkVXNf1.webp 2x"
        data-sizes="auto"
        alt="https://s21.ax1x.com/2024/05/09/pkVXNf1.webp"
        title="pkVXNf1.webp" /></a></p>
<p>每个周期内，HPA Controller 通过用户定义的 hpa 规则（下面会讲到），比如通过资源度量指标 API（可能是 metrics-server 或者 custom-resource-server 服务提供)来获取相应的CPU、Memory指标数据。
这里需要了解一下 k8s 的 APIServer 扩展API的两种方式：
<strong>1、通过 API Aggregation聚合层将外部服务注册到APIServer的特定接口(metrics-server、custom-resource-server）
2、通过 CRD 方式提供服务（这里不涉及）</strong></p>
<p>HPA 提供了三种指标接口，用于不同指标信息的提供：</p>
<ul>
<li>对于资源指标，将使用 <a href="http://metrics.k8s.io/" target="_blank" rel="noopener noreffer ">metrics.k8s.io</a> API，一般由 metrics-server 提供</li>
<li>对于自定义指标，将使用 <a href="http://custom.metrics.k8s.io/" target="_blank" rel="noopener noreffer ">custom.metrics.k8s.io</a> API。 它由其他度量指标方案厂商的“适配器（Adapter）” API 服务器提供（比如 prometheus-adapter)</li>
<li>对于外部指标，将使用 <a href="http://external.metrics.k8s.io/" target="_blank" rel="noopener noreffer ">external.metrics.k8s.io</a> API。可能由上面的自定义指标适配器提供。</li>
</ul>
<p>下图就是 HPA 调用以上注册的接口进行指标获取的流程图
<a href="https://imgse.com/i/pkVXdl6" target="_blank" rel="noopener noreffer "><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s21.ax1x.com/2024/05/09/pkVXdl6.webp"
        data-srcset="https://s21.ax1x.com/2024/05/09/pkVXdl6.webp, https://s21.ax1x.com/2024/05/09/pkVXdl6.webp 1.5x, https://s21.ax1x.com/2024/05/09/pkVXdl6.webp 2x"
        data-sizes="auto"
        alt="https://s21.ax1x.com/2024/05/09/pkVXdl6.webp"
        title="pkVXdl6.webp" /></a>
有个更具体的 网易轻舟提供的架构图
<a href="https://imgse.com/i/pkVXhX8" target="_blank" rel="noopener noreffer "><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s21.ax1x.com/2024/05/09/pkVXhX8.webp"
        data-srcset="https://s21.ax1x.com/2024/05/09/pkVXhX8.webp, https://s21.ax1x.com/2024/05/09/pkVXhX8.webp 1.5x, https://s21.ax1x.com/2024/05/09/pkVXhX8.webp 2x"
        data-sizes="auto"
        alt="https://s21.ax1x.com/2024/05/09/pkVXhX8.webp"
        title="pkVXhX8.webp" /></a>
HPA 执行步骤：
1、HPA Controller 每隔 15s 进行一次流程，先获取用户定义的 HPA规则，然后通过 aggregator 层，请求 metrics-server 获取 CPU 利用率
2、metrics-server 定时从 kubelet 的接口获取到相应的应用指标情况
3、kubelet 是通过内置的 cadvisor(指标收集组件），本质上是通过读取获取 /sys/cgroup/ 下应用的资源情况
4、根据 metrics-server 获取的 CPU 利用率，根据计算公式（下面会说到），得出新的副本数
5、如果用户当前的副本数与计算出来的不一致，则执行扩容或缩容的流程，最终也是把 deployment 资源的 replica （副本值）修改成计算的值
6、Deployment Controller 通过监控到副本值的变化，最终进行pod的扩缩动作</p>
<h2 id="三hpa组件">三、HPA组件</h2>
<p>从 HPA 的架构图可以看出，如果需要完整使用 HPA 的全部指标类型，那么提供三个接口所需的服务</p>
<ul>
<li>metrics-server: 通过 <a href="http://metrics.k8s.io/" target="_blank" rel="noopener noreffer ">metrics.k8s.io</a> API 提供服务</li>
<li>custome-metrics-server: 通过<a href="http://custom.metrics.k8s.io/" target="_blank" rel="noopener noreffer ">custom.metrics.k8s.io</a> API 提供服务</li>
<li>external-metrics-server: 通过 <a href="http://external.metrics.k8s.io/" target="_blank" rel="noopener noreffer ">external.metrics.k8s.io</a> API 提供服务</li>
</ul>
<p>并不是一定是三个组件，像 prometheus-adapter, 已经实现了 metrics-server 组件的接口。因此安装了 prometheus-adapter 就不需要额外安装 metrics-server</p>
<h3 id="metrics-server-的安装">metrics-server 的安装</h3>
<h4 id="安装步骤"><strong>安装步骤：</strong></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 使用 yaml 方式在 k8s 集群安装</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 使用 helm chart 方式安装(前提是需要先安装 helm)</span>
</span></span><span class="line"><span class="cl">$ helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
</span></span></code></pre></div><p>metrics-server 安装完成后， kubectl top 命令就可用，平时需要查看某个pod 的CPU、内存情况，可直接通过该命令查看</p>
<p><strong>验证安装是否成功</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看 metrcis-server 是否部署成功</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get pods -n kube-system -l k8s-app<span class="o">=</span>metrics-server
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">metrics-server-96bbfd9f5-mz75w   1/1     Running   <span class="m">3</span> <span class="o">(</span>72m ago<span class="o">)</span>   8d
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 API 是否注册成功</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get apiservice <span class="p">|</span> grep metrics
</span></span><span class="line"><span class="cl">v1beta1.metrics.k8s.io                 kube-system/metrics-server   True        8d
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 尝试获取节点指标信息</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get --raw <span class="s2">&#34;/apis/metrics.k8s.io/v1beta1/nodes&#34;</span> <span class="p">|</span> jq
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;NodeMetricsList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;selfLink&#34;</span>: <span class="s2">&#34;/apis/metrics.k8s.io/v1beta1/nodes&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;items&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;minikube&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;selfLink&#34;</span>: <span class="s2">&#34;/apis/metrics.k8s.io/v1beta1/nodes/minikube&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;creationTimestamp&#34;</span>: <span class="s2">&#34;2022-04-10T02:46:10Z&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;timestamp&#34;</span>: <span class="s2">&#34;2022-04-10T02:45:49Z&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;window&#34;</span>: <span class="s2">&#34;30s&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;usage&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cpu&#34;</span>: <span class="s2">&#34;138063026n&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;memory&#34;</span>: <span class="s2">&#34;1332100Ki&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 使用 kubectl top 查看应用的CPU及内存</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl top pod --all-namespaces
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                               CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">kube-system   coredns-65c54cc984-d9w46           0m           1Mi
</span></span><span class="line"><span class="cl">kube-system   etcd-minikube                      0m           0Mi
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-minikube            0m           0Mi
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-minikube   0m           0Mi
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-hbwsc                   0m           2Mi
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-minikube            0m           2Mi
</span></span><span class="line"><span class="cl">kube-system   metrics-server-96bbfd9f5-mz75w     0m           0Mi
</span></span><span class="line"><span class="cl">kube-system   storage-provisioner                0m           3Mi
</span></span></code></pre></div><p>custom-metrics-server 的安装
因为 custom-metrics-server 有很多开源项目或者公司都提供了自己的实现，这里只介绍promethues-adapter 的使用</p>
<p><strong>安装步骤</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># helm 是 k8s 的包管理工具，类似于 mac 的 brew，入门可参考：[https://www.jianshu.com/p/4bd853a8068b(Helm](https://www.jianshu.com/p/4bd853a8068b(Helm) 从入门到实践)`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ helm repo add prometheus-community https:<span class="sb">``</span>//prometheus-community<span class="sb">``</span>.github.io<span class="sb">``</span>/helm-charts<span class="sb">`</span>
</span></span><span class="line"><span class="cl">$ helm repo update<span class="sb">`</span>
</span></span><span class="line"><span class="cl">$ helm<span class="sb">`</span> <span class="sb">`</span>install<span class="sb">`</span> <span class="sb">`</span>--name my-release prometheus-community<span class="sb">``</span>/prometheus-adapter<span class="sb">`</span>
</span></span></code></pre></div><p><strong>安装成功验证</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1 <span class="p">|</span> jq
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;APIResourceList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;groupVersion&#34;</span>: <span class="s2">&#34;custom.metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;resources&#34;</span>: <span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h2 id="四hpa功能及算法细节">四、HPA功能及算法细节</h2>
<p>这章节主要介绍 HPA 提供的功能（各种指标的扩缩）、版本的演化及相关算法细节</p>
<h3 id="hpa-演进历程">HPA 演进历程</h3>
<p>目前 HPA 已经支持 autoscaling/v1、autoscaling/v2beta1 和 autoscaling/v2beta2、 autoscaling/v2 共四个版本</p>
<ul>
<li>autoscaling/v1: 只支持设置 CPU 一个指标进行弹性伸缩</li>
<li>autoscaling/v2beta1: 增加了自定义指标</li>
<li>autoscaling/v2beta2: 支持外部指标（当前使用）</li>
<li>autoscaling/v2： 貌似还没正式发布，只是有接口文档定义，和 v2beta2 没有区别</li>
</ul>
<p><strong>v1 版本示例</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">targetCPUUtilizationPercentage</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span></code></pre></div><p><strong>v2beta2 版本:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">php-apache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">metric</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">packets-per-second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">AverageValue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">averageValue</span><span class="p">:</span><span class="w"> </span><span class="l">1k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">object</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">metric</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">requests-per-second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">describedObject</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">main-route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">10k</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">External</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">metric</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">queue_messages_ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;queue=worker_tasks&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">AverageValue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">averageValue</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></div><p>注：最开始 <a href="http://metrics.k8s.io/" target="_blank" rel="noopener noreffer ">metrics.k8s.io</a> 接口是通过 Heapster 提供指标信息，后续才更新为 metrics-server</p>
<h3 id="hpa-算法细节">HPA 算法细节</h3>
<p>Pod 水平自动扩缩控制器根据当前指标和期望指标来计算扩缩比例，后续会单独一章讲解伸缩算法的演进</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">期望副本数</span> <span class="o">=</span> ceil<span class="o">[</span>当前副本数 * <span class="o">(</span>当前指标 / 期望指标<span class="o">)]</span>
</span></span></code></pre></div><p>举个例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 扩容计算</span>
</span></span><span class="line"><span class="cl">当前指标： 200m
</span></span><span class="line"><span class="cl">期望指标： 100m
</span></span><span class="line"><span class="cl">当前副本数： <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">期望副本数</span> <span class="o">=</span> ceil<span class="o">(</span><span class="m">1</span> * <span class="o">(</span><span class="m">200</span> / 100<span class="o">))</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 缩容计算</span>
</span></span><span class="line"><span class="cl">当前指标： 50m
</span></span><span class="line"><span class="cl">期望指标： 100m
</span></span><span class="line"><span class="cl">当前副本数： <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">期望副本数</span> <span class="o">=</span> ceil<span class="o">(</span><span class="m">1</span> * <span class="o">(</span><span class="m">50</span> / 100<span class="o">))</span> <span class="o">=</span> 0.5 接近 <span class="m">1</span>
</span></span></code></pre></div><p><strong>注意点</strong>：扩缩容还有一个全局设置：horizontal-pod-autoscaler-tolerance，容忍值，默认为 0.1，如果计算出来的副本数在这个范围之内，则不进行扩缩容操作。举个例子，比如 HPA 设置 CPU 使用率超过 50% 就触发扩容，因为容忍值为 0.1, 因此只有当 CPU 使用率大于 50% + 50% * 0.1 = 55% 才会触发扩容动作。</p>
<p>虽然算法是很简单，但是 HPA 在计算时会做很多逻辑判断，来保证 HPA 功能的正常使用</p>
<p><strong>1、通过全局参数控制扩缩容频率</strong>
旧版本提供了两个全局参数用于控制扩缩容的频率</p>
<ul>
<li>horizontal-pod-autoscaler-upscale-delay： 默认值为 3 min, 表示第一次扩容后，需要间隔 3min后才能第二次扩容（目前新版本已经去除该参数，扩容本质上是不需要冷却时间的）</li>
<li>horizontal-pod-autoscaler-downscale-delay： 默认值为 5min, 表示第一次缩容后，需要间隔 5min后才能再次缩容
从 v1.12 版本开始，HPA算法调整后，扩容的冷却时间就不需要设置，缩容冷却时间通过
&ndash;horizontal-pod-autoscaler-downscale-stabilization 设置，默认值为 5 min</li>
</ul>
<p><strong>2、计算时针对Pod 异常的优化</strong>
HPA 的计算指标都来自 pod，而因为 deployment 频繁地扩缩容，pod 的数量、状态以及负载情况一直在变化，会导致 HPA 在执行时，获取的指标存在一定的异常,。
比如，</p>
<ul>
<li>
<p>Pod 正在关闭（标记了delete_timestamp) 或者 pod 状态为 failed</p>
</li>
<li>
<p>Pod 由于业务代码初始化比较久，还没 Running，都会导致 metrcis 指标的缺失（metrcis-server 采集不到这种pod的指标数据）
HPA 将 deployment 的所有 pod 的 metrics 指标分为三种集合</p>
</li>
<li>
<p>ready pods， Running状态的Pod且能够通过metrics-server(或其它服务）获取的pod指标数据的列表</p>
</li>
<li>
<p>ignore pods， pending状态的Pod 或者 pod running 并且能够获取到 pod 指标数据，但是pod的启动时间在配置的 initial-readiness-delay和cpu-initialization-period 保护期内</p>
</li>
<li>
<p>missing pods， 处于running状态的pod（非pending、非failed、非deleted状态）， 但是无法获取到 pod 指标数据的列表
以上三个集合的使用如下：</p>
</li>
</ul>
<p>1、在计算pod的平均metrics值的时候，统一把 ignore pods的metrics设置为最小值0，</p>
<p>2、如果HPA扩缩容的方向是扩容，把missing pods的metrics也设置为最小值0，</p>
<p>3、如果是缩容方向则把missing pods的metrics也设置为最大值（如果是Resouce类型，最大值是Pod的request值，否则最大值就是target value）</p>
<p>这种计算策略比较保守，能够最小程度减少HPA 功能对业务容器的频繁变动</p>
<h4 id="总结">总结：</h4>
<ul>
<li>正在关闭的 pod 或 failed pod 不会参与HPA 计算</li>
<li>Pod 指标信息缺少时，在最后计算扩缩副本数的时候才会参与计算</li>
<li>使用 CPU 指标扩缩容时，未就绪（pending) 和刚就绪的 Pod 也不会参与计算</li>
<li>指标信息缺少的Pod，在缩容时，当成 100% 计算，在扩容时，当成 0% 计算</li>
<li>未就绪和刚就绪的Pod, 默认当成 0% 计算</li>
</ul>
<p>注：这里列出一下 HPA 所有全局的配置参数</p>
<p>kube-controller-manager中包含了多个跟Pod 水平自动伸缩相关的启动参数：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>horizontal-pod-autoscaler-sync-period</td>
<td>controller控制循环的检查周期（默认值为15秒）</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-upscale-delay</td>
<td>上次扩容之后，再次扩容需要等待的时间，默认</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-downscale-stabilization</td>
<td>上次缩容执行结束后，再次执行缩容的间隔，默认5分钟</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-downscale-delay</td>
<td>上次扩容之后，再次扩容需要等待的时间，</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-tolerance</td>
<td>缩放比例的容忍值，默认为0.1，即在0.9~1.1不会触发扩缩容</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-use-rest-clients</td>
<td>使用rest client获取metric数据，支持custom metric时需要使用</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-cpu-initialization-period</td>
<td>pod 的初始化时间， 在此时间内的 pod，CPU 资源指标将不会被采纳</td>
</tr>
<tr>
<td>horizontal-pod-autoscaler-initial-readiness-delay</td>
<td>pod 准备时间， 在此时间内的 pod 统统被认为未就绪</td>
</tr>
</tbody>
</table>
<h2 id="五demo示例">五、Demo示例</h2>
<p><strong>步骤1：首先需要新增一个 nginx 应用，部署为 deployment （注：该配置是有点小问题的， HPA是不能计算利用率信息）</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p><strong>步骤2：使用 kubectl 命令部署 nginx deployment 和 hpa 对象</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 部署应用</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl apply -f hap-demo.yaml
</span></span><span class="line"><span class="cl">deployment.apps/hpa-demo created
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看应用部署状态</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get deploy
</span></span><span class="line"><span class="cl">NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">hpa-demo                        0/1     <span class="m">1</span>            <span class="m">0</span>           31s
</span></span><span class="line"><span class="cl">my-release-prometheus-adapter   1/1     <span class="m">1</span>            <span class="m">1</span>           9d
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 创建 HPA 对象</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl autoscale deployment hpa-demo --cpu-percent<span class="o">=</span><span class="m">10</span> --min<span class="o">=</span><span class="m">1</span> --max<span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">horizontalpodautoscaler.autoscaling/hpa-demo autoscaled
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 HPA 状态</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get hpa
</span></span><span class="line"><span class="cl">NAME       REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">hpa-demo   Deployment/hpa-demo   &lt;unknown&gt;/10%   <span class="m">1</span>         <span class="m">10</span>        <span class="m">1</span>          22s
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 HPA 详细信息</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl describe hpa hpa-demo
</span></span><span class="line"><span class="cl">Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+<span class="p">;</span> use autoscaling/v2 HorizontalPodAutoscaler
</span></span><span class="line"><span class="cl">Name:                                                  hpa-demo
</span></span><span class="line"><span class="cl">Namespace:                                             default
</span></span><span class="line"><span class="cl">Labels:                                                &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:                                           &lt;none&gt;
</span></span><span class="line"><span class="cl">CreationTimestamp:                                     Tue, <span class="m">19</span> Apr <span class="m">2022</span> 20:42:29 +0800
</span></span><span class="line"><span class="cl">Reference:                                             Deployment/hpa-demo
</span></span><span class="line"><span class="cl">Metrics:                                               <span class="o">(</span> current / target <span class="o">)</span>
</span></span><span class="line"><span class="cl">  resource cpu on pods  <span class="o">(</span>as a percentage of request<span class="o">)</span>:  &lt;unknown&gt; / 10%
</span></span><span class="line"><span class="cl">Min replicas:                                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">Max replicas:                                          <span class="m">10</span>
</span></span><span class="line"><span class="cl">Deployment pods:                                       <span class="m">1</span> current / <span class="m">0</span> desired
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type           Status  Reason                   Message
</span></span><span class="line"><span class="cl">  ----           ------  ------                   -------
</span></span><span class="line"><span class="cl">  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target<span class="err">&#39;</span>s current scale
</span></span><span class="line"><span class="cl">  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: failed to get cpu utilization: missing request <span class="k">for</span> cpu
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason                        Age               From                       Message
</span></span><span class="line"><span class="cl">  ----     ------                        ----              ----                       -------
</span></span><span class="line"><span class="cl">  Warning  FailedGetResourceMetric       5s <span class="o">(</span>x2 over 20s<span class="o">)</span>  horizontal-pod-autoscaler  failed to get cpu utilization: missing request <span class="k">for</span> cpu
</span></span><span class="line"><span class="cl">  Warning  FailedComputeMetricsReplicas  5s <span class="o">(</span>x2 over 20s<span class="o">)</span>  horizontal-pod-autoscaler  invalid metrics <span class="o">(</span><span class="m">1</span> invalid out of 1<span class="o">)</span>, first error is: failed to get cpu utilization: missing request <span class="k">for</span> cpu
</span></span></code></pre></div><p>由上面步骤可以知道，创建 HPA 成功后 ，由于没有设置 request, 导致 HPA Events 出现错误 failed to get cpu utilization: missing request for cpu ，因为 HPA默认是通过实际的利用率/request作为利用率的数值，因此可以检查Pod的Resource字段中是否包含Request字段。</p>
<p><strong>步骤3：将上面的应用的 yaml 修改为如下：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hpa-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">  </span><span class="c"># 新增内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">50Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">50m</span><span class="w">
</span></span></span></code></pre></div><p><strong>步骤4：然后通过 kubectl 更新 nginx deployment 的配置</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 更新 nginx 应用</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl apply -f hpa.yaml
</span></span><span class="line"><span class="cl">deployment.apps/hpa-demo configured
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 HPA 对象</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl delete hpa hpa-demo
</span></span><span class="line"><span class="cl">horizontalpodautoscaler.autoscaling <span class="s2">&#34;hpa-demo&#34;</span> deleted
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 重新创建 HPA 对象</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl autoscale deployment hpa-demo --cpu-percent<span class="o">=</span><span class="m">10</span> --min<span class="o">=</span><span class="m">1</span> --max<span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl">horizontalpodautoscaler.autoscaling/hpa-demo autoscaled
</span></span></code></pre></div><p><strong>步骤5：对 nginx 应用进行压测</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 获取 nginx 应用 pod 的 IP</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl get pod -o wide
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 新增压测环境 test-hpa， 在容器内部对 nginx 应用进行压测</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~
</span></span><span class="line"><span class="cl">╰─$ kubectl run -it --image busybox test-hpa --restart<span class="o">=</span>Never --rm /bin/sh
</span></span><span class="line"><span class="cl">If you don<span class="err">&#39;</span>t see a <span class="nb">command</span> prompt, try pressing enter.
</span></span><span class="line"><span class="cl">/ <span class="c1"># while true; do wget -q -O- http://&lt;pod_ip&gt;; done</span>
</span></span></code></pre></div><p><strong>步骤6：查看 hpa 扩缩情况</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看 pod 的 CPU、内存指标变化</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl top pod
</span></span><span class="line"><span class="cl">NAME                        CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-75dv8   138m         4Mi
</span></span><span class="line"><span class="cl">test-hpa                    471m         0Mi
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 HPA 扩容具体情况，可以通过 Event 看出，当前CPU使用率 264% 远大于设置的10%，因此进行扩容操作</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl describe hpa hpa-demo
</span></span><span class="line"><span class="cl">Name:                                                  hpa-demo
</span></span><span class="line"><span class="cl">Namespace:                                             default
</span></span><span class="line"><span class="cl">Labels:                                                &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:                                           &lt;none&gt;
</span></span><span class="line"><span class="cl">CreationTimestamp:                                     Wed, <span class="m">20</span> Apr <span class="m">2022</span> 00:20:00 +0800
</span></span><span class="line"><span class="cl">Reference:                                             Deployment/hpa-demo
</span></span><span class="line"><span class="cl">Metrics:                                               <span class="o">(</span> current / target <span class="o">)</span>
</span></span><span class="line"><span class="cl">  resource cpu on pods  <span class="o">(</span>as a percentage of request<span class="o">)</span>:  264% <span class="o">(</span>132m<span class="o">)</span> / 10%
</span></span><span class="line"><span class="cl">Min replicas:                                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">Max replicas:                                          <span class="m">10</span>
</span></span><span class="line"><span class="cl">Deployment pods:                                       <span class="m">1</span> current / <span class="m">4</span> desired
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type            Status  Reason            Message
</span></span><span class="line"><span class="cl">  ----            ------  ------            -------
</span></span><span class="line"><span class="cl">  AbleToScale     True    SucceededRescale  the HPA controller was able to update the target scale to <span class="m">4</span>
</span></span><span class="line"><span class="cl">  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span>
</span></span><span class="line"><span class="cl">  ScalingLimited  True    ScaleUpLimit      the desired replica count is increasing faster than the maximum scale rate
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason                        Age    From                       Message
</span></span><span class="line"><span class="cl">  ----     ------                        ----   ----                       -------
</span></span><span class="line"><span class="cl">  Warning  FailedGetResourceMetric       2m32s  horizontal-pod-autoscaler  failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Warning  FailedComputeMetricsReplicas  2m32s  horizontal-pod-autoscaler  invalid metrics <span class="o">(</span><span class="m">1</span> invalid out of 1<span class="o">)</span>, first error is: failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             32s    horizontal-pod-autoscaler  New size: 4<span class="p">;</span> reason: cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span> above target
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 扩容因为没有冷却窗口的限制，因此一直扩容达到了 10个</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl describe hpa hpa-demo
</span></span><span class="line"><span class="cl">Name:                                                  hpa-demo
</span></span><span class="line"><span class="cl">Namespace:                                             default
</span></span><span class="line"><span class="cl">Labels:                                                &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:                                           &lt;none&gt;
</span></span><span class="line"><span class="cl">CreationTimestamp:                                     Wed, <span class="m">20</span> Apr <span class="m">2022</span> 00:20:00 +0800
</span></span><span class="line"><span class="cl">Reference:                                             Deployment/hpa-demo
</span></span><span class="line"><span class="cl">Metrics:                                               <span class="o">(</span> current / target <span class="o">)</span>
</span></span><span class="line"><span class="cl">  resource cpu on pods  <span class="o">(</span>as a percentage of request<span class="o">)</span>:  0% <span class="o">(</span>0<span class="o">)</span> / 10%
</span></span><span class="line"><span class="cl">Min replicas:                                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">Max replicas:                                          <span class="m">10</span>
</span></span><span class="line"><span class="cl">Deployment pods:                                       <span class="m">10</span> current / <span class="m">10</span> desired
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type            Status  Reason               Message
</span></span><span class="line"><span class="cl">  ----            ------  ------               -------
</span></span><span class="line"><span class="cl">  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation
</span></span><span class="line"><span class="cl">  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span>
</span></span><span class="line"><span class="cl">  ScalingLimited  True    TooManyReplicas      the desired replica count is more than the maximum replica count
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason                        Age   From                       Message
</span></span><span class="line"><span class="cl">  ----     ------                        ----  ----                       -------
</span></span><span class="line"><span class="cl">  Warning  FailedGetResourceMetric       5m8s  horizontal-pod-autoscaler  failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Warning  FailedComputeMetricsReplicas  5m8s  horizontal-pod-autoscaler  invalid metrics <span class="o">(</span><span class="m">1</span> invalid out of 1<span class="o">)</span>, first error is: failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             3m8s  horizontal-pod-autoscaler  New size: 4<span class="p">;</span> reason: cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span> above target
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             2m8s  horizontal-pod-autoscaler  New size: 8<span class="p">;</span> reason: cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span> above target
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             68s   horizontal-pod-autoscaler  New size: 10<span class="p">;</span> reason:
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 pod 的创建情况</span>
</span></span><span class="line"><span class="cl">  ╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl get pod
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-22dwf   0/1     ContainerCreating   <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-4kfbc   0/1     ContainerCreating   <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-75dv8   1/1     Running             <span class="m">0</span>          6m20s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-c979v   1/1     Running             <span class="m">0</span>          2m13s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-cj8tv   0/1     ContainerCreating   <span class="m">0</span>          13s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-k2gkv   1/1     Running             <span class="m">0</span>          2m13s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-k8qb7   1/1     Running             <span class="m">0</span>          2m13s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-rqjm2   0/1     ContainerCreating   <span class="m">0</span>          13s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-tscgj   0/1     ContainerCreating   <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">hpa-demo-6b4467b546-zvzdz   1/1     Running             <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">test-hpa                    1/1     Running             <span class="m">0</span>          4m18s
</span></span></code></pre></div><p><strong>步骤7：停止压测，查看HPA情况</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 没有压测后，cpu 使用率很快降下来，HPA 开始执行缩容操作</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl describe hpa
</span></span><span class="line"><span class="cl">Name:                                                  hpa-demo
</span></span><span class="line"><span class="cl">Namespace:                                             default
</span></span><span class="line"><span class="cl">Labels:                                                &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:                                           &lt;none&gt;
</span></span><span class="line"><span class="cl">CreationTimestamp:                                     Wed, <span class="m">20</span> Apr <span class="m">2022</span> 00:20:00 +0800
</span></span><span class="line"><span class="cl">Reference:                                             Deployment/hpa-demo
</span></span><span class="line"><span class="cl">Metrics:                                               <span class="o">(</span> current / target <span class="o">)</span>
</span></span><span class="line"><span class="cl">  resource cpu on pods  <span class="o">(</span>as a percentage of request<span class="o">)</span>:  0% <span class="o">(</span>0<span class="o">)</span> / 10%
</span></span><span class="line"><span class="cl">Min replicas:                                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">Max replicas:                                          <span class="m">10</span>
</span></span><span class="line"><span class="cl">Deployment pods:                                       <span class="m">10</span> current / <span class="m">1</span> desired
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type            Status  Reason            Message
</span></span><span class="line"><span class="cl">  ----            ------  ------            -------
</span></span><span class="line"><span class="cl">  AbleToScale     True    SucceededRescale  the HPA controller was able to update the target scale to <span class="m">1</span>
</span></span><span class="line"><span class="cl">  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span>
</span></span><span class="line"><span class="cl">  ScalingLimited  True    TooFewReplicas    the desired replica count is less than the minimum replica count
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason                        Age   From                       Message
</span></span><span class="line"><span class="cl">  ----     ------                        ----  ----                       -------
</span></span><span class="line"><span class="cl">  Warning  FailedGetResourceMetric       13m   horizontal-pod-autoscaler  failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Warning  FailedComputeMetricsReplicas  13m   horizontal-pod-autoscaler  invalid metrics <span class="o">(</span><span class="m">1</span> invalid out of 1<span class="o">)</span>, first error is: failed to get cpu utilization: did not receive metrics <span class="k">for</span> any ready pods
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             11m   horizontal-pod-autoscaler  New size: 4<span class="p">;</span> reason: cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span> above target
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             10m   horizontal-pod-autoscaler  New size: 8<span class="p">;</span> reason: cpu resource utilization <span class="o">(</span>percentage of request<span class="o">)</span> above target
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             9m4s  horizontal-pod-autoscaler  New size: 10<span class="p">;</span> reason:
</span></span><span class="line"><span class="cl">  Warning  FailedGetResourceMetric       6m4s  horizontal-pod-autoscaler  failed to get cpu utilization: unable to get metrics <span class="k">for</span> resource cpu: no metrics returned from resource metrics API
</span></span><span class="line"><span class="cl">  Warning  FailedComputeMetricsReplicas  6m4s  horizontal-pod-autoscaler  invalid metrics <span class="o">(</span><span class="m">1</span> invalid out of 1<span class="o">)</span>, first error is: failed to get cpu utilization: unable to get metrics <span class="k">for</span> resource cpu: no metrics returned from resource metrics API
</span></span><span class="line"><span class="cl">  Normal   SuccessfulRescale             4s    horizontal-pod-autoscaler  New size: 1<span class="p">;</span> reason: All metrics below target
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 检查缩容后的应用的副本数</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl get deployments.apps
</span></span><span class="line"><span class="cl">NAME       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">hpa-demo   1/1     <span class="m">1</span>            <span class="m">1</span>           16m
</span></span><span class="line"><span class="cl"><span class="c1"># 检查 hpa 的相关信息</span>
</span></span><span class="line"><span class="cl">╭─guoweikuang@guoweikngdeMBP2 ~/hpa
</span></span><span class="line"><span class="cl">╰─$ kubectl get hpa
</span></span><span class="line"><span class="cl">NAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">hpa-demo   Deployment/hpa-demo   0%/10%    <span class="m">1</span>         <span class="m">10</span>        <span class="m">1</span>          15m
</span></span></code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-05-08</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.125.6">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/guoweikuang" target="_blank">guoweikuang</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
