<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Python 定时任务最佳实践 - guoweikuang 技术博客</title><meta name="Description" content=""><meta property="og:url" content="https://guoweikuang.github.io/posts/python_schduler_01/">
  <meta property="og:site_name" content="guoweikuang 技术博客">
  <meta property="og:title" content="Python 定时任务最佳实践">
  <meta property="og:description" content="背景 最近有个需求，需要实现一个定时或定期任务的功能，需要实现每月、每日、每时、一次性等需求，必须是轻量级不依赖其它额外组件，并能支持动态添加">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-09-26T12:03:30+08:00">
    <meta property="article:modified_time" content="2019-09-26T12:03:30+08:00">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="定时任务">
    <meta property="article:tag" content="源码分析">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python 定时任务最佳实践">
<meta name="twitter:description" content="背景 最近有个需求，需要实现一个定时或定期任务的功能，需要实现每月、每日、每时、一次性等需求，必须是轻量级不依赖其它额外组件，并能支持动态添加">
<meta name="application-name" content="guoweikuang 技术博客">
<meta name="apple-mobile-web-app-title" content="guoweikuang 技术博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://guoweikuang.github.io/posts/python_schduler_01/" /><link rel="prev" href="https://guoweikuang.github.io/posts/helm/" /><link rel="next" href="https://guoweikuang.github.io/posts/kustomize/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Python 定时任务最佳实践",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/guoweikuang.github.io\/posts\/python_schduler_01\/"
        },"genre": "posts","keywords": "Python, 定时任务, 源码分析","wordcount":  5123 ,
        "url": "https:\/\/guoweikuang.github.io\/posts\/python_schduler_01\/","datePublished": "2019-09-26T12:03:30+08:00","dateModified": "2019-09-26T12:03:30+08:00","publisher": {
            "@type": "Organization",
            "name": "guoweikuang"},"author": {
                "@type": "Person",
                "name": "guoweikuang"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="" data-header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="guoweikuang 技术博客">guoweikuang 技术博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="guoweikuang 技术博客">guoweikuang 技术博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Python 定时任务最佳实践</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/guoweikuang" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>guoweikuang</a></span>&nbsp;<span class="post-category">included in <a href="/categories/python/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2019-09-26">2019-09-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;5123 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#定时任务库对比">定时任务库对比</a></li>
    <li><a href="#schedule-库">schedule 库</a>
      <ul>
        <li><a href="#schedule-常见问题">schedule 常见问题</a></li>
        <li><a href="#schedule-源码阅读">schedule 源码阅读</a></li>
      </ul>
    </li>
    <li><a href="#apscheduler-库">APScheduler 库</a>
      <ul>
        <li><a href="#apscheduler-的架构及工作原理">APScheduler 的架构及工作原理</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="背景">背景</h2>
<p>最近有个需求，需要实现一个定时或定期任务的功能，需要实现每月、每日、每时、一次性等需求，必须是轻量级不依赖其它额外组件，并能支持动态添加任务。由于当前任务信息保存在集群 ETCD 数据库中，因此对任务持久化要求不高，每次重启都直接读取 ETCD 任务信息，为了后面扩展，还需要添加任务持久化功能。</p>
<h2 id="定时任务库对比">定时任务库对比</h2>
<p>根据上面需求，从社区中找到了几个 Python 好用的任务调度库。有以下几个库：</p>
<ul>
<li>schedule：Python job scheduling for humans. 轻量级，无需配置的作业调度库</li>
<li>python-crontab： 针对系统 Cron 操作 crontab 文件的作业调度库</li>
<li>Apscheduler：一个高级的 Python 任务调度库</li>
<li>Celery： 是一个简单，灵活，可靠的分布式系统，用于处理大量消息，同时为操作提供维护此类系统所需的工具, 也可用于任务调度</li>
</ul>
<p>优缺点对比：</p>
<ul>
<li>schedule 优点是简单、轻量级、无需配置、语法简单，缺点是阻塞式调用、无法动态添加或删除任务</li>
<li>Python-crontab 优点是针对于系统 crontab 操作，支持定时、定期任务，能够动态添加任务，不能实现一次性任务需求</li>
<li>Apscheduler 优点支持定时、定期、一次性任务，支持任务持久化及动态添加、支持配置各种持久化存储源(如 redis、MongoDB)，支持接入到各种异步框架(如 gevent、asyncio、tornado)</li>
<li>Celery 支持配置定期任务、支持 crontab 模式配置，不支持一次性定时任务</li>
</ul>
<h2 id="schedule-库">schedule 库</h2>
<p>人类的Python 任务调度库，和 requests 库一样 for humans. 这个库也是最轻量级的一个任务调度库，schedule 允许用户使用简单、人性化的语法以预定的时间间隔定期运行Python函数(或其它可调用函数)。</p>
<p>直接使用 <code>pip install schedule</code>进行安装使用，下面来看看官网给的示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">schedule</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义你要周期运行的函数</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m working...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>               <span class="c1"># 每隔 10 分钟运行一次 job 函数</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>                    <span class="c1"># 每隔 1 小时运行一次 job 函数</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;10:30&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>         <span class="c1"># 每天在 10:30 时间点运行 job 函数</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">monday</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>                  <span class="c1"># 每周一 运行一次 job 函数</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">wednesday</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;13:15&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>   <span class="c1"># 每周三 13：15 时间点运行 job 函数</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;:17&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>        <span class="c1"># 每分钟的 17 秒时间点运行 job 函数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>   <span class="c1"># 运行所有可以运行的任务</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>通过上面示例，可以很容易学会使用 schedule 库，可以设置秒、分钟、小时、天、周来运行任务，然后通过一个死循环，一直不断地运行所有的计划任务。</p>
<h3 id="schedule-常见问题">schedule 常见问题</h3>
<p><strong>1、如何并行执行任务？</strong></p>
<p>schedule 是阻塞式的，默认情况下， schedule 按顺序执行所有的作业，不能达到并行执行任务。如下所示：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">arrow</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">schedule</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job1</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job1 start time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job1 end time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job2</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job2 start time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job2 end time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job3</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job3 start time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;job3 end time: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</span></span></code></pre></div><p>返回部分结果如下所示，几个任务并不是并行开始的，是安装时间顺序先后开始的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">job3 start time: 2019-06-01 09:27:54+00:00
</span></span><span class="line"><span class="cl">job3 end time: 2019-06-01 09:28:04+00:00
</span></span><span class="line"><span class="cl">job1 start time: 2019-06-01 09:28:04+00:00
</span></span><span class="line"><span class="cl">job1 end time: 2019-06-01 09:28:06+00:00
</span></span><span class="line"><span class="cl">job3 start time: 2019-06-01 09:28:13+00:00
</span></span><span class="line"><span class="cl">job3 end time: 2019-06-01 09:28:23+00:00
</span></span><span class="line"><span class="cl">job2 start time: 2019-06-01 09:28:23+00:00
</span></span><span class="line"><span class="cl">job2 end time: 2019-06-01 09:28:28+00:00
</span></span><span class="line"><span class="cl">job1 start time: 2019-06-01 09:28:28+00:00
</span></span><span class="line"><span class="cl">job1 end time: 2019-06-01 09:28:30+00:00
</span></span><span class="line"><span class="cl">job3 start time: 2019-06-01 09:28:30+00:00
</span></span><span class="line"><span class="cl">job3 end time: 2019-06-01 09:28:40+00:00
</span></span><span class="line"><span class="cl">job1 start time: 2019-06-01 09:28:40+00:00
</span></span><span class="line"><span class="cl">job1 end time: 2019-06-01 09:28:42+00:00
</span></span></code></pre></div><p>如果需要实现并行，那么使用多线程方式运行任务，官方给出的并行方案如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">schedule</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m running on thread </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_threaded</span><span class="p">(</span><span class="n">job_func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">job_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">job_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">job_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1"># 我在项目里也是通过对每个任务运行后台线程方式, 可以通过 run_daemon_thread 起一个守护线程方式来达到动态</span>
</span></span><span class="line"><span class="cl"><span class="n">添加任务的功能</span><span class="err">，</span><span class="n">每个任务最终通过新开线程方式执行</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ensure_schedule</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">do_some</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ensure_schedule_2</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">print_some</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_daemon_thread</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">job_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">job_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">job_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">__start_schedule_deamon</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">schedule_run</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">schedule_run</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init_schedule_job</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="n">run_daemon_thread</span><span class="p">(</span><span class="n">ensure_schedule</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">run_daemon_thread</span><span class="p">(</span><span class="n">ensure_schedule_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="n">init_schedule_job</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">__start_schedule_deamon</span><span class="p">()</span>
</span></span></code></pre></div><p><strong>2、如何在不阻塞主线程的情况下连续运行调度程序？</strong></p>
<p>官方推荐了这个方式，在单独的线程中运行调度程序，如下，在单独的线程中运行 run_pending 调度程序。通过 threading 库的 Event 来实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="c1"># https://github.com/mrhwick/schedule/blob/master/schedule/__init__.py</span>
</span></span><span class="line"><span class="cl"> <span class="k">def</span> <span class="nf">run_continuously</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Continuously run, while executing pending jobs at each elapsed
</span></span></span><span class="line"><span class="cl"><span class="s2">        time interval.
</span></span></span><span class="line"><span class="cl"><span class="s2">        @return cease_continuous_run: threading.Event which can be set to
</span></span></span><span class="line"><span class="cl"><span class="s2">        cease continuous run.
</span></span></span><span class="line"><span class="cl"><span class="s2">        Please note that it is *intended behavior that run_continuously()
</span></span></span><span class="line"><span class="cl"><span class="s2">        does not run missed jobs*. For example, if you&#39;ve registered a job
</span></span></span><span class="line"><span class="cl"><span class="s2">        that should run every minute and you set a continuous run interval
</span></span></span><span class="line"><span class="cl"><span class="s2">        of one hour then your job won&#39;t be run 60 times at each interval but
</span></span></span><span class="line"><span class="cl"><span class="s2">        only once.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cease_continuous_run</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">class</span> <span class="nc">ScheduleThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@classmethod</span>
</span></span><span class="line"><span class="cl">            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="ow">not</span> <span class="n">cease_continuous_run</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">continuous_thread</span> <span class="o">=</span> <span class="n">ScheduleThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">continuous_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cease_continuous_run</span>
</span></span></code></pre></div><p><strong>3、是否支持时区</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 官方不计划支持时区，可使用： </span>
</span></span><span class="line"><span class="cl"><span class="n">讨论</span><span class="err">：</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dbader</span><span class="o">/</span><span class="n">schedule</span><span class="o">/</span><span class="n">pull</span><span class="o">/</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">时区解决</span><span class="err">：</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">imiric</span><span class="o">/</span><span class="n">schedule</span><span class="o">/</span><span class="n">tree</span><span class="o">/</span><span class="n">feat</span><span class="o">/</span><span class="n">timezone</span> 
</span></span></code></pre></div><p><strong>4、如果我的任务抛出异常怎么办?</strong></p>
<p>schedule 不捕获作业执行期间发生的异常，因此在任务执行期间的任何异常都会冒泡并中断调度的 run_xyz(如 run_pending ) 函数, 也就是 run_pending 中断退出，导致其它任务无法执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">functools</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">catch_exceptions</span><span class="p">(</span><span class="n">cancel_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">catch_exceptions_decorator</span><span class="p">(</span><span class="n">job_func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">job_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">job_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="kn">import</span> <span class="nn">traceback</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">cancel_on_failure</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">schedule</span><span class="o">.</span><span class="n">CancelJob</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">wrapper</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">catch_exceptions_decorator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@catch_exceptions</span><span class="p">(</span><span class="n">cancel_on_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bad_task</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">bad_task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">另外一种解决方案</span><span class="err">：</span>
</span></span><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gist</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">mplewis</span><span class="o">/</span><span class="mi">8483</span><span class="n">f1c24f2d6259aef6</span>
</span></span></code></pre></div><p><strong>5、如何设置只跑一次的任务?</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job_that_executes_once</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Do some work ...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">schedule</span><span class="o">.</span><span class="n">CancelJob</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;22:30&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job_that_executes_once</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>6、如何一次取消多个任务？</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 通过 tag 函数给它们添加唯一标识符进行分组，取消时通过标识符进行取消相应组的任务</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Andrea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;hourly-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Monica&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;hourly-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Derek&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>7、如何传递参数给任务函数</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="schedule-源码阅读">schedule 源码阅读</h3>
<p>使用 0.6.0 版本最新代码进行分析，加起来才 6百多行，实现很简洁，先来看看当前的文件结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">➜ tree
</span></span></span><span class="line"><span class="cl"><span class="s2"># 省略部分文件，代码全部在 __init__.py 中
</span></span></span><span class="line"><span class="cl"><span class="s2">.
</span></span></span><span class="line"><span class="cl"><span class="s2">├── schedule
</span></span></span><span class="line"><span class="cl"><span class="s2">│   └── __init__.py
</span></span></span><span class="line"><span class="cl"><span class="s2">├── setup.py
</span></span></span><span class="line"><span class="cl"><span class="s2">├── test_schedule.py
</span></span></span><span class="line"><span class="cl"><span class="s2">└── tox.ini
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">先从一段简单的代码分析
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">schedule</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">arrow</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;time: </span><span class="si">{</span><span class="n">arrow</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;YYYY-MM-DD HH:mm:ss&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, I&#39;m working...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start schedule...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">start schedule...
</span></span></span><span class="line"><span class="cl"><span class="s2">time: 2019-09-27 21:28:14, I&#39;m working...
</span></span></span><span class="line"><span class="cl"><span class="s2">time: 2019-09-27 21:28:24, I&#39;m working...
</span></span></span><span class="line"><span class="cl"><span class="s2">time: 2019-09-27 21:28:34, I&#39;m working...
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>先来看看 run_pending 做了什么事情：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_pending</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Calls :meth:`run_pending &lt;Scheduler.run_pending&gt;` on the
</span></span></span><span class="line"><span class="cl"><span class="s2">    :data:`default scheduler instance &lt;default_scheduler&gt;`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">default_scheduler</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>  <span class="c1"># what? default_scheduler 又是什么？</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">#: Default :class:`Scheduler &lt;Scheduler&gt;` object</span>
</span></span><span class="line"><span class="cl"><span class="n">default_scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>   
</span></span></code></pre></div><p>原来是 Scheduler 类的一个实例，接下来去 Scheduler 找 run_pending 看看这个方法做了什么操作.</p>
<h4 id="scheduler-类">Scheduler 类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Objects instantiated by the :class:`Scheduler &lt;Scheduler&gt;` are
</span></span></span><span class="line"><span class="cl"><span class="s2">    factories to create jobs, keep record of scheduled jobs and
</span></span></span><span class="line"><span class="cl"><span class="s2">    handle their execution.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span></code></pre></div><p>1、初始化函数 <code>__init__</code> 做了什么初始化操作，结果只是简单地设置了一个保存 Job 的列表，这也是 schedule 简洁设计的一个重要点，所有运行的任务都使用一个列表来保存在内存中，不提供任何接入不同存储的配置项。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Objects instantiated by the :class:`Scheduler &lt;Scheduler&gt;` are
</span></span></span><span class="line"><span class="cl"><span class="s2">    factories to create jobs, keep record of scheduled jobs and
</span></span></span><span class="line"><span class="cl"><span class="s2">    handle their execution.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 省略部分代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        运行所有计划运行的作业
</span></span></span><span class="line"><span class="cl"><span class="s2">        Run all jobs that are scheduled to run.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Please note that it is *intended behavior that run_pending()
</span></span></span><span class="line"><span class="cl"><span class="s2">        does not run missed jobs*. For example, if you&#39;ve registered a job
</span></span></span><span class="line"><span class="cl"><span class="s2">        that should run every minute and you only call run_pending()
</span></span></span><span class="line"><span class="cl"><span class="s2">        in one hour increments then your job won&#39;t be run 60 times in
</span></span></span><span class="line"><span class="cl"><span class="s2">        between but only once.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">runnable_jobs</span> <span class="o">=</span> <span class="p">(</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">should_run</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">runnable_jobs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span></span></code></pre></div><p>2、接着看看 run_pending 方法做了什么，可以看到 run_pending 从 jobs 列表中获取当前可以运行的 job 保存在 runnable_jobs， 并对 runnable_jobs 元祖进行排序并对每一个 job 执行 _run_job 方法, 这个地方可能有人会有疑问，Job 到底是个什么对象，为什么可以用 sorted 方法排序，难道 Job 对象实现了一些 Python 黑魔法函数，例如 <code>__lt__</code> 等?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_run_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">CancelJob</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">CancelJob</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cancel_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Delete a scheduled job.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param job: The job to be unscheduled
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span></code></pre></div><p>3、进入 _run_job 方法，可以看到这个方法只是负责调用 job 对象的 run 方法运行这个 job 而已，并且根据 run 返回的对象判断是否取消该任务. 取消一个 job 就是从 jobs 列表中将这个 job 对象去除即可</p>
<h4 id="job-类">Job 类</h4>
<p>从上面 Schedule 追踪下面，最后还是调用 job 的 run 方法进行操作，接下来就继续对 Job 追踪</p>
<p>1、<strong>Job 的初始化方法做了什么</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    A periodic job as used by :class:`Scheduler`.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param interval: A quantity of a certain time unit
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param scheduler: The :class:`Scheduler &lt;Scheduler&gt;` instance that
</span></span></span><span class="line"><span class="cl"><span class="s2">                      this job will register itself with once it has
</span></span></span><span class="line"><span class="cl"><span class="s2">                      been fully configured in :meth:`Job.do()`.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Every job runs at a given fixed time interval that is defined by:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    * a :meth:`time unit &lt;Job.second&gt;`
</span></span></span><span class="line"><span class="cl"><span class="s2">    * a quantity of `time units` defined by `interval`
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    A job is usually created and returned by :meth:`Scheduler.every`
</span></span></span><span class="line"><span class="cl"><span class="s2">    method, which also defines its `interval`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>  <span class="c1"># pause interval * unit between runs（配置运行任务的时间单位数量，如 seconds(10).do(job),10 就是这个时间单位数量）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># upper limit to the interval（ interval 的上限)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">job_func</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the job job_func to run   (运行任务的函数，通常是我们定义需要定时执行的代码逻辑)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># time units, e.g. &#39;minutes&#39;, &#39;hours&#39;, ... （时间单位）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># optional time at which this job runs   (设置在某个时间点运行)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">last_run</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># datetime of the last run   （上次执行的时间)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># datetime of the next run    (下次执行的时间)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># timedelta between runs, only valid for</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Specific day of the week to start on （指定一周中的第几天运行）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># unique set of tags for the job  （Job 的唯一tag 标识）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>  <span class="c1"># scheduler to register with  （Scheduler 类，可继承并使用自己实现的 Scheduler 类）</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">   <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        看这个黑魔法函数，就是上面 Scheduler 类中 job 可以使用 sorted 排序的原因
</span></span></span><span class="line"><span class="cl"><span class="s2">        PeriodicJobs are sortable based on the scheduled time they
</span></span></span><span class="line"><span class="cl"><span class="s2">        run next.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">next_run</span>  
</span></span></code></pre></div><p>2、<strong>job run 方法的逻辑</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Run the job and immediately reschedule it.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return: The return value returned by the `job_func`
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running job </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">last_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_next_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span>
</span></span></code></pre></div><p>3、<strong>every 函数操作</strong></p>
<p>可能看到这里的朋友觉得有点混乱了，job 是什么时候实例化的，又是什么时候加入 Scheduler 的 jobs 列表的，其实我没有按照 示例代码的顺序来讲话，可以回到前面代码示例中有下面这句代码在 run_pending 之前：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span></span></code></pre></div><p>也就是这个地方实例化 Job 类的，可以跳到这段代码分析分析：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># 省略部分代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">every</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Schedule a new periodic job.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param interval: A quantity of a certain time unit
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return: An unconfigured :class:`Job &lt;Job&gt;`
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">job</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">every</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Calls :meth:`every &lt;Scheduler.every&gt;` on the
</span></span></span><span class="line"><span class="cl"><span class="s2">    :data:`default scheduler instance &lt;default_scheduler&gt;`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">default_scheduler</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</span></span></code></pre></div><p>4、<strong>do 函数操作</strong></p>
<p>可以看到在调用 every 函数时，最终调用的是 Scheduler 类的 every 方法，该方法主要是根据设置的间隔时间（interval) 实例化 Job 类并返回该实例，这段代码同样没有 job 加入 Scheduler 的 jobs 列表的逻辑，那就是在 seconds.do 方法进行的操作，接着翻代码看看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Specifies the job_func that should be called every time the
</span></span></span><span class="line"><span class="cl"><span class="s2">        job runs.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Any additional arguments are passed on to job_func when
</span></span></span><span class="line"><span class="cl"><span class="s2">        the job runs.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param job_func: The function to be scheduled
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return: The invoked job instance
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">job_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">job_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_func</span><span class="p">,</span> <span class="n">job_func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># job_funcs already wrapped by functools.partial won&#39;t have</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># __name__, __module__ or __doc__ and the update_wrapper()</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># call will fail.</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_next_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>
</span></span></code></pre></div><ul>
<li>首先使用标准库的 partial (偏函数) 先提前为 job_func(我们提供的业务逻辑代码)设置参数，用一些默认参数包装一个可调用对象,返回结果是可调用对象，并且可以像原始对象一样对待，冻结部分函数位置函数或关键字参数，简化函数,更少更灵活的函数参数调用。</li>
<li>update_wrapper 做了什么操作，这个函数的作用就是从 **被修饰的函数(job_func) ** 中取出一些属性值来，赋值给 <strong>修饰器函数(self.job_func)</strong> 。默认 partial 对象没有 <strong>name</strong>和 <strong>doc</strong>, 这种情况下，对于装饰器函数非常难以debug.</li>
<li>接着就是 self._schedule_next_run 方法，这个是 schedule 库的核心代码，有点复杂，下面慢慢解释</li>
<li>接下来一行就是想要的答案了，这个时候将当前 Job 类加入 Scheduler 类的 jobs 列表中，append(self) 这个 self 就是当前的 Job 类</li>
</ul>
<p>5、<strong>核心 _schedule_next_run</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_schedule_next_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Compute the instant when this job should run next.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 第一步，判断当前运行的时间单位是否在指定范围内，不在则报错</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;seconds&#39;</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="s1">&#39;weeks&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="n">ScheduleValueError</span><span class="p">(</span><span class="s1">&#39;Invalid unit&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">				<span class="c1"># 如果 interval 的上限时间不为 None, 判断 interval 上限时间是否小于 interval</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 小于则报错，latest 用于 every(A).to(B).seconds 每 N 秒执行一次 job 任务，</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 其中 A &lt;= N &lt;= B. 所以 A(interval) &lt;= B (latest)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="n">ScheduleError</span><span class="p">(</span><span class="s1">&#39;`latest` is greater than `interval`&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 执行时间随机从 interval 到 latest 之前取值</span>
</span></span><span class="line"><span class="cl">            <span class="n">interval</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 下面两行用于获取下一次执行的时间</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span> <span class="n">interval</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># start_day 这个只会在设置一周的第几天执行才会有，所以 unit 时间单位不是 weeks 就报错</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">!=</span> <span class="s1">&#39;weeks&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="n">ScheduleValueError</span><span class="p">(</span><span class="s1">&#39;`unit` should be </span><span class="se">\&#39;</span><span class="s1">weeks</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">weekdays</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;monday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;tuesday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;wednesday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;thursday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;friday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;saturday&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;sunday&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果天数的标识不是上面的，报错</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">weekdays</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="n">ScheduleValueError</span><span class="p">(</span><span class="s1">&#39;Invalid start day&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">weekday</span> <span class="o">=</span> <span class="n">weekdays</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_day</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># datetime 的 weekday() 函数，计算目标时间是否已经在本周发送</span>
</span></span><span class="line"><span class="cl">            <span class="n">days_ahead</span> <span class="o">=</span> <span class="n">weekday</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">days_ahead</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Target day already happened this week</span>
</span></span><span class="line"><span class="cl">                <span class="n">days_ahead</span> <span class="o">+=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days_ahead</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="n">ScheduleValueError</span><span class="p">((</span><span class="s1">&#39;Invalid unit without&#39;</span>
</span></span><span class="line"><span class="cl">                                          <span class="s1">&#39; specifying start day&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;microsecond&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">hour</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">minute</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If we are running for the first time, make sure we run</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># at the specified time *today* (or *this hour*) as well</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_run</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;hours&#39;</span> \
</span></span><span class="line"><span class="cl">                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span> \
</span></span><span class="line"><span class="cl">                        <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span>
</span></span><span class="line"><span class="cl">                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">second</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;minutes&#39;</span> \
</span></span><span class="line"><span class="cl">                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span><span class="o">.</span><span class="n">second</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">-</span> \
</span></span><span class="line"><span class="cl">                                    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Let&#39;s see if we will still make that time we specified today</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">next_run</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span>
</span></span></code></pre></div><h2 id="apscheduler-库">APScheduler 库</h2>
<p>APScheduler（Advanced Python Scheduler）是基于Quartz的一个Python定时任务框架，实现了Quartz的所有功能, 是一个轻量级但功能强大的进程内任务调度程序。它有以下三个特点：</p>
<ul>
<li>类似于 Liunx Cron 的调度程序(可选的开始/结束时间)</li>
<li>基于时间间隔的执行调度(周期性调度，可选的开始/结束时间)</li>
<li>一次性执行任务(在设定的日期/时间运行一次任务)</li>
</ul>
<p>可以按照个人喜好来混合和匹配调度系统和存储作业的后端存储，支持以下几种后台作业存储：</p>
<ul>
<li>Memory</li>
<li>SQLAlchemy (任何 SQLAlchemy 支持的关系型数据库)</li>
<li>MongoDB</li>
<li>Redis</li>
<li>ZooKeeper</li>
<li>RethinkDB</li>
</ul>
<p>APScheduler 集成了以下几个 Python 框架：</p>
<ul>
<li>asyncio</li>
<li>gevent</li>
<li>Tornado</li>
<li>Twisted</li>
<li>Qt</li>
</ul>
<p>总结以上，APScheduler 支持基于日期、固定时间、crontab 形式三种形式的任务调度，可以灵活接入各种类型的后台作业存储来持久化作业，同时提供了多种调度器(后面提及)，集成多种 Python 框架，可以根据实际情况灵活组合后台存储以及调度器来使用。</p>
<h3 id="apscheduler-的架构及工作原理">APScheduler 的架构及工作原理</h3>
<p><strong>1、APScheduler 基本概念</strong></p>
<p>APScheduler 由四个组件构成（注：该部分翻译至官方文档）：</p>
<ul>
<li>
<p>triggers 触发器</p>
<p>触发器包含调度逻辑。每个作业（job）都有自己的触发器，用于确定下一个作业何时运行。除了最初的配置，触发器是完全无状态的</p>
</li>
<li>
<p>job stores 作业存储</p>
<p>job stores 是存放作业的地方，默认保存在内存中。作业数据序列化后保存至持久性数据库，从持久性数据库加载回来时会反序列化。作业存储(job stores)不将作业数据保存在内存中(默认存储除外)，相反，内存只是充当后端存储在保存、加载、更新、查找作业时的中间人角色。作业存储不能在调度器（schedulers) 之间共享</p>
</li>
<li>
<p>executors 执行器</p>
<p>执行器处理作业的运行。它们通常通过将作业中的指定可调用部分提交给线程或进程池来实现这一点。 当作业完成后，执行器通知调度器，然后调度器发出一个适当的事件</p>
</li>
<li>
<p>schedulers 调度器</p>
<p>调度器是将其余部分绑定在一起的工具。通常只有一个调度器(scheduler)在应用程序中运行。应用程序开发者通常不直接处理作业存储(job stores)、执行器(executors)或者触发器(triggers)。相反，调度器提供了适当的接口来处理它们。配置作业存储(job stores)和执行器(executors)是通过调度器(scheduler)来完成的,就像添加、修改和删除 job(作业)一样</p>
</li>
</ul>
<p><strong>2、APScheduler 架构图</strong>
<a href="https://imgse.com/i/pkZG1G4" target="_blank" rel="noopener noreffer "><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s21.ax1x.com/2024/05/10/pkZG1G4.webp"
        data-srcset="https://s21.ax1x.com/2024/05/10/pkZG1G4.webp, https://s21.ax1x.com/2024/05/10/pkZG1G4.webp 1.5x, https://s21.ax1x.com/2024/05/10/pkZG1G4.webp 2x"
        data-sizes="auto"
        alt="https://s21.ax1x.com/2024/05/10/pkZG1G4.webp"
        title="papscheduler架构图" /></a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2019-09-26</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">定时任务</a>,&nbsp;<a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/helm/" class="prev" rel="prev" title="Helm 从入门到实践"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Helm 从入门到实践</a>
            <a href="/posts/kustomize/" class="next" rel="next" title="kustomize 最简实践">kustomize 最简实践<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.125.6">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/guoweikuang" target="_blank">guoweikuang</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
